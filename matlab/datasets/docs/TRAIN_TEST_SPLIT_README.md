# Training vs Test Dataset Analysis

## Overview

This document explains the train/test split used for earthquake control RL training and provides analysis of dataset characteristics.

## Dataset Organization

### Training Set (`training_set_v2/`)
- **M4.5 (PGA 0.25g)**: 10 synthetic variants
- **M5.7 (PGA 0.35g)**: 10 synthetic variants
- **M7.4 (PGA 0.75g)**: 10 synthetic variants
- **M8.4 (PGA 0.9g)**: 10 synthetic variants

**Total**: 40 training earthquakes

### Test Set (Held-out)
- **M4.5**: `PEER_small_M4.5_PGA0.25g.csv` (PEER ground motion)
- **M5.7**: `PEER_moderate_M5.7_PGA0.35g.csv` (PEER ground motion)
- **M7.4**: `PEER_high_M7.4_PGA0.75g.csv` (PEER ground motion)
- **M8.4**: `PEER_insane_M8.4_PGA0.9g.csv` (PEER ground motion)

**Total**: 4 test earthquakes (NEVER used in training)

## Statistical Comparison

### Key Findings

| Magnitude | Test PGA | Train PGA (mean±σ) | PGA Match | Test RMS | Train RMS (mean±σ) | RMS Difference |
|-----------|----------|--------------------|-----------|-----------|--------------------|----------------|
| M4.5      | 0.250g   | 0.250±0.000g       | ✓ Perfect | 0.073g    | 0.060±0.006g       | 17.7%          |
| M5.7      | 0.350g   | 0.350±0.000g       | ✓ Perfect | 0.100g    | 0.080±0.005g       | 20.1%          |
| M7.4      | 0.750g   | 0.750±0.000g       | ✓ Perfect | 0.331g    | 0.170±0.015g       | 48.6%          |
| M8.4      | 0.900g   | 0.900±0.000g       | ✓ Perfect | 0.274g    | 0.189±0.018g       | 31.1%          |

### Detailed Statistics

#### M4.5 (Small Earthquake)
- **Test**:
  - PGA: 0.250g (2.45 m/s²)
  - RMS: 0.073g (0.71 m/s²)
  - Duration: 20.0s
  - Arias Intensity: 1.62 m/s
  - Dominant Frequency: 2.00 Hz

- **Training (10 variants)**:
  - PGA: 0.250±0.000g (exact match)
  - RMS: 0.060±0.006g (17.7% lower)
  - Duration: 20.0±0.0s
  - Arias Intensity: 1.11±0.23 m/s
  - Dominant Frequency: 3.10±0.54 Hz

#### M5.7 (Moderate Earthquake)
- **Test**:
  - PGA: 0.350g (3.43 m/s²)
  - RMS: 0.100g (0.98 m/s²)
  - Duration: 40.0s
  - Arias Intensity: 6.20 m/s
  - Dominant Frequency: 1.50 Hz

- **Training (10 variants)**:
  - PGA: 0.350±0.000g (exact match)
  - RMS: 0.080±0.005g (20.1% lower)
  - Duration: 40.0±0.0s
  - Arias Intensity: 3.97±0.52 m/s
  - Dominant Frequency: 2.45±0.35 Hz

#### M7.4 (High Earthquake)
- **Test**:
  - PGA: 0.750g (7.36 m/s²)
  - RMS: 0.331g (3.25 m/s²)
  - Duration: 60.0s
  - Arias Intensity: 101.25 m/s
  - Dominant Frequency: 1.00 Hz

- **Training (10 variants)**:
  - PGA: 0.750±0.000g (exact match)
  - RMS: 0.170±0.015g (48.6% lower)
  - Duration: 60.0±0.0s
  - Arias Intensity: 26.92±4.76 m/s
  - Dominant Frequency: 1.55±0.40 Hz

#### M8.4 (Extreme Earthquake)
- **Test**:
  - PGA: 0.900g (8.83 m/s²)
  - RMS: 0.274g (2.69 m/s²)
  - Duration: 120.0s
  - Arias Intensity: 139.17 m/s
  - Dominant Frequency: 0.30 Hz

- **Training (10 variants)**:
  - PGA: 0.900±0.000g (exact match)
  - RMS: 0.189±0.018g (31.1% lower)
  - Duration: 120.0±0.0s
  - Arias Intensity: 66.55±12.12 m/s
  - Dominant Frequency: 1.29±0.20 Hz

## Analysis Insights

### 1. PGA Matching
✅ **Perfect Match**: All training variants have EXACT PGA match to test (0.0% difference)
- This ensures the model is tested on the correct magnitude scale
- Training data properly covers the target PGA range

### 2. RMS Differences
⚠️ **Moderate Differences**: RMS values are 17-49% lower in training compared to test
- **Reason**: Training data uses synthetic earthquakes with different frequency content
- **Impact**: Test earthquakes are more challenging (higher energy content)
- **Benefit**: This creates a harder evaluation, preventing overfitting

### 3. Energy Content (Arias Intensity)
- Test earthquakes have 1.5-4× higher Arias Intensity than training
- This makes test set MORE challenging than training
- Ensures conservative performance estimates

### 4. Frequency Content
- Test signals have lower dominant frequencies (more realistic)
- Training variants span a range of frequencies (diversity)
- Good coverage of the earthquake frequency spectrum

## Train/Test Split Verification

### ✅ Proper Separation
1. **Test signals are NEVER seen during training**
   - Test files are PEER ground motions (real earthquake recordings)
   - Training files are synthetic variants
   - Zero overlap between train and test

2. **Distribution Coverage**
   - Training data covers similar PGA ranges as test
   - Sufficient diversity in training (10 variants per magnitude)
   - Test represents real-world earthquake characteristics

3. **Generalization Testing**
   - Test earthquakes are more challenging (higher RMS/energy)
   - Different frequency content from training
   - True measure of model generalization capability

## Visualization Files

Generated by `plot_train_vs_test.py`:

1. **train_vs_test_comparison.png**
   - 4×4 grid showing detailed comparison for each magnitude
   - Time-domain waveforms
   - PGA distributions (violin plots)
   - RMS distributions
   - Power spectral density (frequency domain)

2. **train_vs_test_statistics.png**
   - Statistical summary across all magnitudes
   - Bar charts comparing test vs training means
   - Error bars showing training variance
   - Summary table with percentage differences

3. **train_vs_test_waveforms.png**
   - Overlay plots showing all waveforms per magnitude
   - Test signals highlighted in red
   - Training variants shown in color-coded overlays
   - Clear visualization of train/test separation

## How to Generate Plots

```bash
cd /Users/Shared/dev/git/struct-engineer-ai/matlab/datasets
/Users/Shared/dev/git/struct-engineer-ai/.venv/bin/python plot_train_vs_test.py
```

This will create all three visualization files and print detailed statistics.

## Implications for RL Training

### 1. Curriculum Learning
The training progresses through 4 stages:
- **Stage 1**: M4.5 (easiest) - learn basic control
- **Stage 2**: M5.7 (moderate) - refine policy
- **Stage 3**: M7.4 (challenging) - handle strong earthquakes
- **Stage 4**: M8.4 (extreme) - maximum difficulty

### 2. Generalization
- Test earthquakes have DIFFERENT frequency content than training
- Test earthquakes have HIGHER energy content (more challenging)
- This ensures the model truly generalizes, not just memorizes

### 3. Unbiased Evaluation
- Zero contamination between train and test
- Test set represents real PEER ground motions
- Performance on test set is a true measure of control effectiveness

### 4. Diversity in Training
- 10 variants per magnitude class
- Random selection during training (data augmentation)
- Prevents overfitting to single earthquake signature

## Best Practices

### ✅ DO:
- Use test set ONLY for final evaluation
- Train on synthetic variants
- Report test performance as primary metric
- Use proper train/test split

### ❌ DON'T:
- Train on test earthquakes
- Tune hyperparameters based on test performance
- Mix training and test data
- Optimize for test set (overfitting)

## Performance Expectations

Given the test set is MORE challenging than training (higher RMS/energy):

- **Good performance**: If test results are close to training performance
- **Excellent performance**: If test results exceed training (robust generalization)
- **Poor performance**: If test results are much worse (overfitting)

For earthquake control, we expect:
- **M4.5/M5.7**: Excellent control (easy cases)
- **M7.4**: Good control (challenging but learnable)
- **M8.4**: Moderate control (extreme case, partial success expected)

## References

- PEER Ground Motion Database: https://ngawest2.berkeley.edu/
- Training set generation: `generate_training_earthquakes_v2.py`
- Baseline correction: `fix_baseline_drift_v2.py`
- Visualization: `plot_train_vs_test.py`

---

**Author**: Siddharth
**Date**: January 2026
**Version**: v2 (with baseline correction and proper tapering)
